language: node_js
node_js: '13'
cache: yarn

services:
  - docker

env:
  - DOCKER_TAG=sourcegraph/lsif-node:0.6.0

install:
  - yarn

jobs:
  include:
    - stage: test
      script:
        - yarn run build
    - stage: npm_publish
      script:
        - yarn run build
        - npm publish --dry-run
    - stage: docker_push
      script:
        - docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}
        - docker build -t ${DOCKER_TAG} --build-arg TAG=0.6.0 .
        # - docker push ${DOCKER_TAG}


stages:
  - test
  - name: npm_publish
    # if: tag =~ ^v AND fork = false
  - name: docker_push
    # if: tag =~ ^v AND fork = false

branches:
  only:
    - garo/ci-releases
