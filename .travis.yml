language: node_js
node_js: '13'
cache: yarn

services:
  - docker

env:
  - TEST_TAG=0.0.0
  - DOCKER_TAG=sourcegraph/lsif-node:${TEST_TAG}

install:
  - yarn

jobs:
  include:
    - stage: test
      script:
        - yarn run build
    - stage: release
      script:
        - yarn run build
        - npm publish --dry-run
        - echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin
        - docker build -t ${DOCKER_TAG} --build-arg TAG=${TEST_TAG} .
        # - docker push ${DOCKER_TAG}

stages:
  - test
  - name: release
    # if: tag =~ ^v AND fork = false

branches:
  only:
    - garo/ci-releases
